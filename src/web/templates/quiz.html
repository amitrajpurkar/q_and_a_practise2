{% extends "base.html" %}

{% block content %}
<h1 class="text-2xl font-bold mb-4">Offline Quiz</h1>

{% if load_error %}
  <p class="mb-4 text-red-600">{{ load_error }}</p>
{% endif %}

<form
  method="post"
  action="/api/quiz/start"
  class="mb-6 flex flex-col gap-2 md:flex-row md:items-end md:gap-4"
>
  <div>
    <label for="topic" class="block text-sm font-semibold mb-1">Topic</label>
    <select
      id="topic"
      name="topic"
      class="border rounded px-2 py-1 min-w-[8rem]"
      required
    >
      <option value="" disabled {% if not selected_topic %}selected{% endif %}></option>
      {% for t in topics %}
        <option value="{{ t }}" {% if selected_topic == t %}selected{% endif %}>{{ t }}</option>
      {% endfor %}
    </select>
  </div>

  <div>
    <label for="difficulty" class="block text-sm font-semibold mb-1">Difficulty</label>
    <select
      id="difficulty"
      name="difficulty"
      class="border rounded px-2 py-1 min-w-[8rem]"
      required
    >
      <option value="" disabled {% if not selected_difficulty %}selected{% endif %}></option>
      {% for d in difficulties %}
        <option value="{{ d }}" {% if selected_difficulty == d %}selected{% endif %}>{{ d|capitalize }}</option>
      {% endfor %}
    </select>
  </div>

  <button
    type="submit"
    class="mt-2 md:mt-0 inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded hover:bg-blue-700"
  >
    Start quiz
  </button>
</form>

<p class="text-sm text-gray-700 mb-2">
  To start a new quiz select topic and difficulty.
</p>

<hr class="my-4 border-gray-300" />

{% if current_topic and current_difficulty %}
  <p class="text-sm mb-4">
    Quiz in progress for
    <span class="font-semibold">{{ current_topic }}</span>
    –
    <span class="font-semibold">{{ current_difficulty|capitalize }}</span>
    {% if current_index and total_questions %}
      (Question {{ current_index }} of {{ total_questions }})
    {% endif %}
  </p>
{% endif %}

<div id="quiz-region" class="space-y-4">
  {% if last_result %}
    <p class="font-semibold">
      {% if last_result.correct %}
        Correct!
      {% else %}
        Incorrect.
      {% endif %}
    </p>
  {% endif %}

  {% if question and session_id %}
    <div class="space-y-2">
      <p class="font-semibold">Question:</p>
      <p class="mb-2">{{ question.text }}</p>
      <form method="post" action="/api/quiz/{{ session_id }}/answer" class="space-y-2">
        <input type="hidden" name="question_id" value="{{ question.id }}" />
        {% for option in question.options %}
          <label class="flex items-center gap-2">
            <input
              type="radio"
              name="chosen_option"
              value="{{ option }}"
              required
            />
            <span>{{ option }}</span>
          </label>
        {% endfor %}
        <button
          type="submit"
          class="mt-3 inline-flex items-center px-4 py-2 bg-green-600 text-white text-sm font-semibold rounded hover:bg-green-700"
        >
          Submit answer
        </button>
      </form>
    </div>
  {% elif last_result and last_result.finished and summary %}
    <div class="space-y-2">
      <p class="font-semibold">Quiz summary</p>
      <ul class="list-disc list-inside space-y-1">
        <li>
          <span class="font-semibold">Questions attempted:</span>
          {{ summary.total_questions }}
        </li>
        <li>
          <span class="font-semibold">Correct answers:</span>
          {{ summary.correct_count }}
        </li>
        <li>
          <span class="font-semibold">Incorrect answers:</span>
          {{ summary.incorrect_count }}
        </li>
        <li>
          <span class="font-semibold">Score:</span>
          {{ summary.score_percentage|round(1) }}%
        </li>
        <li>
          <span class="font-semibold">Time spent:</span>
          {{ summary.duration_seconds|round(1) }} s
        </li>
      </ul>

      {% if summary.incorrect_questions %}
        <div class="mt-4 space-y-2">
          <p class="font-semibold">Review incorrect answers</p>
          <ul class="space-y-2">
            {% for item in summary.incorrect_questions %}
              <li class="border border-gray-200 rounded p-2">
                <p class="text-sm font-semibold">Question:</p>
                <p class="text-sm mb-1">{{ item.question.text }}</p>
                <p class="text-sm">
                  <span class="font-semibold">Your answer:</span>
                  {{ item.chosen_option }}
                </p>
                <p class="text-sm">
                  <span class="font-semibold">Correct answer:</span>
                  {{ item.correct_option }}
                </p>
              </li>
            {% endfor %}
          </ul>
        </div>
      {% else %}
        <p class="mt-3 text-sm font-semibold text-green-700">
          All answers were correct – great job!
        </p>
      {% endif %}
    </div>
  {% elif last_result and last_result.finished %}
    <p class="font-semibold">Quiz finished.</p>
  {% endif %}
</div>
{% endblock %}
